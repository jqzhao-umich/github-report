name: Generate Iteration Report

on:
  # Run daily at 11:00 PM Eastern time to check if it's the scheduled date
  schedule:
    - cron: '0 3 * * *'  # 11 PM EDT (summer)
    - cron: '0 4 * * *'  # 11 PM EST (winter)
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: report-publish
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyyaml
          
      - name: Check if today is scheduled report date
        id: check_date
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ORG_NAME: ${{ secrets.GITHUB_ORG_NAME || 'WeMoAD-umich' }}
        run: |
          python - << 'EOF'
          import os
          import sys
          import yaml
          from datetime import datetime
          from zoneinfo import ZoneInfo
          from pathlib import Path
          
          try:
              # Get current date in Eastern Time
              eastern = ZoneInfo("America/New_York")
              today = datetime.now(eastern).date()
              
              print(f"Today (Eastern): {today}")
              print(f"Current timezone: {datetime.now(eastern).tzname()}")
              
              # Read the iteration schedule file
              schedule_file = Path(".github/iteration-schedule.yml")
              
              if not schedule_file.exists():
                  print("Schedule file not found, will check GitHub Projects")
                  scheduled_date = None
              else:
                  with open(schedule_file) as f:
                      config = yaml.safe_load(f)
                  
                  scheduled_date_str = config.get('next_iteration_end_date')
                  if scheduled_date_str:
                      from datetime import date
                      scheduled_date = date.fromisoformat(scheduled_date_str)
                      print(f"Scheduled report date: {scheduled_date}")
                  else:
                      print("No scheduled date in config")
                      scheduled_date = None
              
              # Check if today matches the scheduled date
              should_generate = False
              iteration_name = None
              
              if scheduled_date and today == scheduled_date:
                  print("âœ“ Today matches the scheduled date!")
                  should_generate = True
                  # Read iteration name from config
                  if schedule_file.exists():
                      with open(schedule_file) as f:
                          config = yaml.safe_load(f)
                      iteration_name = config.get('next_iteration_name', 'Unknown')
              else:
                  print("Today does not match the scheduled date")
                  print("Checking GitHub Projects for current iteration end date...")
                  
                  # Fallback: Check GitHub Projects if no schedule or date doesn't match
                  from agent_mcp_demo.utils.github_projects_api import get_current_iteration_info
                  
                  token = os.environ.get("GITHUB_TOKEN")
                  org_name = os.environ.get("GITHUB_ORG_NAME")
                  
                  if token and org_name:
                      iteration_info = get_current_iteration_info(token, org_name, "Michigan App Team Task Board")
                      
                      if iteration_info:
                          end_date_str = iteration_info.get('end_date', '')
                          if end_date_str:
                              end_date = datetime.fromisoformat(end_date_str.replace('Z', '+00:00'))
                              end_date_eastern = end_date.astimezone(eastern).date()
                              
                              print(f"Current iteration end date from GitHub: {end_date_eastern}")
                              
                              if today == end_date_eastern:
                                  print("âœ“ Today is the iteration end date from GitHub Projects!")
                                  should_generate = True
                                  iteration_name = iteration_info.get('name', 'Unknown')
              
              # Write output
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  if should_generate:
                      f.write('should_generate=true\n')
                      f.write(f'iteration_name={iteration_name or "Unknown"}\n')
                  else:
                      f.write('should_generate=false\n')
              
              if should_generate:
                  print("â†’ Will generate report")
              else:
                  print("â†’ Skipping report generation")
                  
          except Exception as e:
              print(f"Error checking date: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          EOF
          
      - name: Generate and publish report
        if: steps.check_date.outputs.should_generate == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ORG_NAME: ${{ secrets.GITHUB_ORG_NAME || 'WeMoAD-umich' }}
        run: |
          python - << 'EOF'
          import asyncio
          import os
          from agent_mcp_demo.server import github_report_api
          from agent_mcp_demo.utils.report_publisher import ReportPublisher
          
          async def main():
              # Generate report
              print("Generating report...")
              report_content = await github_report_api()
              
              # Check if report generation was successful
              if report_content.startswith("GitHub token not set") or \
                 report_content.startswith("Unexpected error:"):
                  print(f"Error generating report: {report_content}")
                  return False
              
              # Parse iteration info from report
              lines = report_content.split("\n")
              org_name = None
              iteration_name = None
              start_date = None
              end_date = None
              
              for i, line in enumerate(lines):
                  if line.startswith("GitHub Organization:"):
                      org_name = line.split(": ", 1)[1].strip()
                  elif "Iteration Name:" in line:
                      iteration_name = line.split(":", 1)[1].strip()
                  elif "Start Date:" in line:
                      start_date = line.split(":", 1)[1].strip()
                  elif "End Date:" in line:
                      end_date = line.split(":", 1)[1].strip()
              
              if not org_name:
                  print("Could not parse organization name from report")
                  return False
              
              # Publish report
              print(f"Publishing report for {org_name} - {iteration_name}")
              publisher = ReportPublisher()
              result = await publisher.publish_report(
                  report_content=report_content,
                  org_name=org_name,
                  iteration_name=iteration_name,
                  start_date=start_date,
                  end_date=end_date,
                  skip_duplicate_check=False
              )
              
              print(f"Publish result: {result}")
              return result.get("status") == "published"
          
          success = asyncio.run(main())
          exit(0 if success else 1)
          EOF
          
      - name: Update schedule for next iteration
        if: steps.check_date.outputs.should_generate == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ORG_NAME: ${{ secrets.GITHUB_ORG_NAME || 'WeMoAD-umich' }}
        run: |
          python - << 'EOF'
          import os
          import yaml
          from datetime import datetime
          from zoneinfo import ZoneInfo
          from pathlib import Path
          from agent_mcp_demo.utils.github_projects_api import get_current_iteration_info
          
          try:
              token = os.environ.get("GITHUB_TOKEN")
              org_name = os.environ.get("GITHUB_ORG_NAME")
              
              if not token or not org_name:
                  print("Missing required environment variables")
                  exit(0)  # Don't fail the workflow
              
              # Get next iteration info from GitHub Projects
              iteration_info = get_current_iteration_info(token, org_name, "Michigan App Team Task Board")
              
              if not iteration_info:
                  print("No next iteration found, clearing schedule")
                  schedule_data = {
                      'next_iteration_end_date': None,
                      'next_iteration_name': None,
                      'last_updated': datetime.now(ZoneInfo("America/New_York")).isoformat()
                  }
              else:
                  end_date_str = iteration_info.get('end_date', '')
                  if end_date_str:
                      # Parse and convert to date only (YYYY-MM-DD)
                      end_date = datetime.fromisoformat(end_date_str.replace('Z', '+00:00'))
                      end_date_eastern = end_date.astimezone(ZoneInfo("America/New_York"))
                      
                      schedule_data = {
                          'next_iteration_end_date': end_date_eastern.date().isoformat(),
                          'next_iteration_name': iteration_info.get('name', 'Unknown'),
                          'last_updated': datetime.now(ZoneInfo("America/New_York")).isoformat()
                      }
                      
                      print(f"Updated schedule for next iteration: {schedule_data['next_iteration_name']}")
                      print(f"Next report date: {schedule_data['next_iteration_end_date']}")
                  else:
                      print("No end date found for next iteration")
                      schedule_data = {
                          'next_iteration_end_date': None,
                          'next_iteration_name': None,
                          'last_updated': datetime.now(ZoneInfo("America/New_York")).isoformat()
                      }
              
              # Write to schedule file
              schedule_file = Path(".github/iteration-schedule.yml")
              with open(schedule_file, 'w') as f:
                  yaml.dump(schedule_data, f, default_flow_style=False)
              
              print("Schedule file updated successfully")
              
          except Exception as e:
              print(f"Error updating schedule: {e}")
              import traceback
              traceback.print_exc()
              # Don't fail the workflow if schedule update fails
              exit(0)
          EOF
          
      - name: Commit and push reports
        if: steps.check_date.outputs.should_generate == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/ reports/ .github/iteration-schedule.yml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-generate report for ${{ steps.check_date.outputs.iteration_name }}

Generated by GitHub Actions on iteration end date
Updated schedule for next iteration
$(date +'%Y-%m-%d %H:%M:%S %Z')"
            git push
          fi
          
      - name: Summary
        if: steps.check_date.outputs.should_generate == 'true'
        run: |
          echo "âœ… Successfully generated and published report for ${{ steps.check_date.outputs.iteration_name }}"
          echo "ðŸ“„ Files committed to repository"
          echo "ðŸŒ GitHub Pages will update automatically"
